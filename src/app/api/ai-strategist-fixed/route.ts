import { NextRequest, NextResponse } from 'next/server'
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

export async function POST(request: NextRequest) {
  try {
    console.log('[AI-STRATEGIST-FIXED] API called')
    
    const requestBody = await request.json()
    const { user_id, message, website_intelligence } = requestBody
    
    console.log('[AI-STRATEGIST-FIXED] Request data:', {
      user_id,
      message: message?.substring(0, 50) + '...',
      has_website_intelligence: !!website_intelligence
    })

    // Handle website intelligence if available
    if (website_intelligence && website_intelligence.analysis) {
      console.log('[AI-STRATEGIST-FIXED] Using website intelligence for specific insights')
      
      const systemPrompt = `You are Ruth's most brutally honest business advisor. Analyze her ACTUAL page content and give her insights that will shock her with their accuracy.

RUTH'S ACTUAL PAGE CONTENT:
${JSON.stringify(website_intelligence.analysis, null, 2)}

RULES:
- Reference Ruth's EXACT headlines, CTAs, and content 
- NO generic consultant templates or numbered lists
- NO theoretical bullshit - only insights based on HER page
- Point out specific words, phrases, and positioning choices SHE made
- Show exactly WHERE on her page the problems are

Example: "Ruth, your headline 'Remove Yourself Without Revenue Dipping' is doing X problem because Y. Here's the exact text that's killing conversions: [quote her actual copy]. This costs you money because Z."

Her actual headlines: ${JSON.stringify(website_intelligence.analysis.extractedMessaging?.headlines || [])}
Her actual CTAs: ${JSON.stringify(website_intelligence.analysis.extractedMessaging?.callsToAction || [])}

Give her insights that make her think "Holy shit, how did you know that about my page?"

Be conversational, direct, and reference her ACTUAL content. No consultant-speak templates.`

      const completion = await openai.chat.completions.create({
        model: "gpt-4o",
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: message }
        ],
        max_tokens: 1000,
        temperature: 0.7,
      })

      const aiResponse = completion.choices[0]?.message?.content || 'I apologize, but I encountered an error processing your request.'
      
      console.log('[AI-STRATEGIST-FIXED] Website intelligence response generated, length:', aiResponse.length)
      
      return NextResponse.json({
        reply: aiResponse,
        has_reply: true,
        reply_preview: aiResponse.substring(0, 100) + "...",
        error: undefined
      })
    }

    // Fallback for requests without website intelligence
    console.log('[AI-STRATEGIST-FIXED] No website intelligence, providing general response')
    
    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        { 
          role: 'system', 
          content: `You are Ruth's AI Business Strategist. Provide helpful business strategy advice.

CRITICAL: NO asterisks (*), bullet points, or markdown formatting EVER. Use plain text only.` 
        },
        { role: 'user', content: message }
      ],
      max_tokens: 800,
      temperature: 0.7,
    })

    const aiResponse = completion.choices[0]?.message?.content || 'I apologize, but I encountered an error processing your request.'
    
    console.log('[AI-STRATEGIST-FIXED] General response generated, length:', aiResponse.length)
    
    return NextResponse.json({
      reply: aiResponse,
      has_reply: true,
      reply_preview: aiResponse.substring(0, 100) + "...",
      error: undefined
    })
    
  } catch (error) {
    console.error('[AI-STRATEGIST-FIXED] Error:', error)
    
    return NextResponse.json({
      reply: 'I apologize, but I encountered an error processing your request. Please try again.',
      error: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 })
  }
}